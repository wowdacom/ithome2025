<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>部落格後台管理</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        margin: 0;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1,
      h2 {
        color: #333;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      textarea {
        height: 120px;
        resize: vertical;
      }
      button {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
      }
      button:hover {
        background: #0056b3;
      }
      button.secondary {
        background: #6c757d;
      }
      button.danger {
        background: #dc3545;
      }
      .search-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }
      .search-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .search-row > div {
        flex: 1;
      }
      .articles-list {
        margin-top: 20px;
      }
      .article-item {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 4px;
      }
      .article-meta {
        color: #666;
        font-size: 0.9em;
      }
      .article-actions {
        margin-top: 10px;
      }
      .edit-form {
        display: none;
        background: #f8f9fa;
        padding: 15px;
        margin-top: 10px;
        border-radius: 4px;
      }
      .hidden {
        display: none;
      }
      .loading {
        color: #666;
        font-style: italic;
      }
      .error {
        color: #dc3545;
        background: #f8d7da;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .success {
        color: #155724;
        background: #d4edda;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>部落格後台管理</h1>

      <!-- 新增文章表單 -->
      <section>
        <h2>新增文章</h2>
        <form id="createForm">
          <div class="form-group">
            <label for="title">標題</label>
            <input type="text" id="title" name="title" required />
          </div>
          <div class="form-group">
            <label for="category">分類</label>
            <input type="text" id="category" name="category" required />
          </div>
          <div class="form-group">
            <label for="content">內容</label>
            <textarea id="content" name="content" required></textarea>
          </div>
          <button type="submit">新增文章</button>
          <button type="reset" class="secondary">清除</button>
        </form>
      </section>

      <!-- 搜尋區域 -->
      <section>
        <h2>搜尋文章</h2>
        <div class="search-section">
          <div class="search-row">
            <div>
              <label for="searchKeyword">關鍵字</label>
              <input
                type="text"
                id="searchKeyword"
                placeholder="搜尋標題或內容"
              />
            </div>
            <div>
              <label for="searchCategory">分類</label>
              <input type="text" id="searchCategory" placeholder="特定分類" />
            </div>
          </div>
          <div class="search-row">
            <div>
              <label for="searchDateFrom">開始日期</label>
              <input type="date" id="searchDateFrom" />
            </div>
            <div>
              <label for="searchDateTo">結束日期</label>
              <input type="date" id="searchDateTo" />
            </div>
          </div>
          <button onclick="searchArticles()">搜尋</button>
          <button onclick="loadAllArticles()" class="secondary">
            顯示全部
          </button>
        </div>
      </section>

      <!-- 文章列表 -->
      <section>
        <h2>文章列表</h2>
        <div id="articlesContainer">
          <div class="loading">載入中...</div>
        </div>
      </section>
    </div>

    <script>
      const API_BASE = "/api";

      // 載入所有文章
      async function loadAllArticles() {
        try {
          showLoading();
          const response = await fetch(`${API_BASE}/articles`);
          const articles = await response.json();
          displayArticles(articles);
        } catch (error) {
          showError("載入文章失敗: " + error.message);
        }
      }

      // 搜尋文章
      async function searchArticles() {
        try {
          showLoading();
          const params = new URLSearchParams();

          const keyword = document.getElementById("searchKeyword").value.trim();
          const category = document
            .getElementById("searchCategory")
            .value.trim();
          const dateFrom = document.getElementById("searchDateFrom").value;
          const dateTo = document.getElementById("searchDateTo").value;

          if (keyword) params.set("keyword", keyword);
          if (category) params.set("category", category);
          if (dateFrom) params.set("dateFrom", dateFrom);
          if (dateTo) params.set("dateTo", dateTo);

          const response = await fetch(`${API_BASE}/articles/search?${params}`);
          const articles = await response.json();
          displayArticles(articles);
        } catch (error) {
          showError("搜尋失敗: " + error.message);
        }
      }

      // 新增文章
      document
        .getElementById("createForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          try {
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            const response = await fetch(`${API_BASE}/articles`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });

            if (response.ok) {
              showSuccess("文章新增成功");
              e.target.reset();
              loadAllArticles();
            } else {
              const error = await response.json();
              showError("新增失敗: " + (error.message || response.statusText));
            }
          } catch (error) {
            showError("新增失敗: " + error.message);
          }
        });

      // 更新文章
      async function updateArticle(id, data) {
        try {
          const response = await fetch(`${API_BASE}/articles/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          if (response.ok) {
            showSuccess("文章更新成功");
            loadAllArticles();
          } else {
            const error = await response.json();
            showError("更新失敗: " + (error.message || response.statusText));
          }
        } catch (error) {
          showError("更新失敗: " + error.message);
        }
      }

      // 顯示文章列表
      function displayArticles(articles) {
        const container = document.getElementById("articlesContainer");

        if (articles.length === 0) {
          container.innerHTML = '<div class="loading">沒有找到文章</div>';
          return;
        }

        container.innerHTML = articles
          .map(
            (article) => `
                <div class="article-item">
                    <h3>${escapeHtml(article.title)}</h3>
                    <div class="article-meta">
                        分類: ${escapeHtml(article.category)} | 
                        建立: ${formatDate(article.created_at)} |
                        更新: ${formatDate(article.updated_at)}
                    </div>
                    <p>${escapeHtml(article.content.substring(0, 150))}${
              article.content.length > 150 ? "..." : ""
            }</p>
                    <div class="article-actions">
                        <button onclick="toggleEdit('${
                          article.id
                        }')">編輯</button>
                    </div>
                    <div id="edit-${article.id}" class="edit-form">
                        <form onsubmit="submitEdit(event, '${article.id}')">
                            <div class="form-group">
                                <label>標題</label>
                                <input type="text" name="title" value="${escapeHtml(
                                  article.title
                                )}" required>
                            </div>
                            <div class="form-group">
                                <label>分類</label>
                                <input type="text" name="category" value="${escapeHtml(
                                  article.category
                                )}" required>
                            </div>
                            <div class="form-group">
                                <label>內容</label>
                                <textarea name="content" required>${escapeHtml(
                                  article.content
                                )}</textarea>
                            </div>
                            <button type="submit">更新</button>
                            <button type="button" onclick="toggleEdit('${
                              article.id
                            }')" class="secondary">取消</button>
                        </form>
                    </div>
                </div>
            `
          )
          .join("");
      }

      // 切換編輯表單
      function toggleEdit(id) {
        const form = document.getElementById(`edit-${id}`);
        form.style.display = form.style.display === "none" ? "block" : "none";
      }

      // 提交編輯
      function submitEdit(e, id) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        updateArticle(id, data);
        toggleEdit(id);
      }

      // 工具函數
      function showLoading() {
        document.getElementById("articlesContainer").innerHTML =
          '<div class="loading">載入中...</div>';
      }

      function showError(message) {
        const existing = document.querySelector(".error");
        if (existing) existing.remove();

        const div = document.createElement("div");
        div.className = "error";
        div.textContent = message;
        document.querySelector(".container").prepend(div);

        setTimeout(() => div.remove(), 5000);
      }

      function showSuccess(message) {
        const existing = document.querySelector(".success");
        if (existing) existing.remove();

        const div = document.createElement("div");
        div.className = "success";
        div.textContent = message;
        document.querySelector(".container").prepend(div);

        setTimeout(() => div.remove(), 3000);
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function formatDate(dateStr) {
        if (!dateStr) return "N/A";
        return new Date(dateStr).toLocaleString("zh-TW");
      }

      // 頁面載入時執行
      document.addEventListener("DOMContentLoaded", loadAllArticles);
    </script>
  </body>
</html>
