<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>部落格後台管理</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        margin: 0;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1,
      h2 {
        color: #333;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      textarea {
        height: 120px;
        resize: vertical;
      }
      button {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
      }
      button:hover {
        background: #0056b3;
      }
      button.secondary {
        background: #6c757d;
      }
      button.danger {
        background: #dc3545;
      }
      .search-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }
      .search-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .search-row > div {
        flex: 1;
      }
      .articles-list {
        margin-top: 20px;
      }
      .article-item {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 4px;
      }
      .article-meta {
        color: #666;
        font-size: 0.9em;
      }
      .article-actions {
        margin-top: 10px;
      }
      .edit-form {
        display: none;
        background: #f8f9fa;
        padding: 15px;
        margin-top: 10px;
        border-radius: 4px;
      }
      .hidden {
        display: none;
      }
      .loading {
        color: #666;
        font-style: italic;
      }
      .error {
        color: #dc3545;
        background: #f8d7da;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .success {
        color: #155724;
        background: #d4edda;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .message {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .message.success {
        color: #155724;
        background: #d4edda;
        border: 1px solid #c3e6cb;
      }
      .message.error {
        color: #721c24;
        background: #f8d7da;
        border: 1px solid #f5c6cb;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
      }
      .fade-enter-active,
      .fade-leave-active {
        transition: opacity 0.3s;
      }
      .fade-enter-from,
      .fade-leave-to {
        opacity: 0;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="container">
        <h1>部落格後台管理</h1>

        <!-- 訊息提示組件 -->
        <message-display
          :message="message"
          @clear="clearMessage"
        ></message-display>

        <!-- 新增文章表單組件 -->
        <article-form
          ref="articleForm"
          :loading="loading"
          @create-article="handleCreateArticle"
        ></article-form>

        <!-- 搜尋組件 -->
        <article-search
          :loading="loading"
          @search="handleSearch"
          @load-all="handleLoadAll"
        ></article-search>

        <!-- 文章列表組件 -->
        <article-list
          :articles="articles"
          :loading="loading"
          @update-article="handleUpdateArticle"
        ></article-list>
      </div>
    </div>

    <script>
      const { createApp } = Vue;

      // MessageDisplay 組件 - 處理訊息顯示
      const MessageDisplay = {
        props: ["message"],
        emits: ["clear"],
        template: `
          <div v-if="message.text" :class="['message', message.type]">
            {{ message.text }}
          </div>
        `,
        mounted() {
          if (this.message.text) {
            setTimeout(
              () => {
                this.$emit("clear");
              },
              this.message.type === "error" ? 5000 : 3000
            );
          }
        },
        watch: {
          "message.text"() {
            if (this.message.text) {
              setTimeout(
                () => {
                  this.$emit("clear");
                },
                this.message.type === "error" ? 5000 : 3000
              );
            }
          },
        },
      };

      // ArticleForm 組件 - 新增文章表單
      const ArticleForm = {
        props: ["loading"],
        emits: ["create-article"],
        data() {
          return {
            form: {
              title: "",
              category: "",
              content: "",
            },
          };
        },
        template: `
          <section>
            <h2>新增文章</h2>
            <form @submit.prevent="handleSubmit">
              <div class="form-group">
                <label for="title">標題</label>
                <input 
                  type="text" 
                  id="title" 
                  v-model="form.title" 
                  required 
                />
              </div>
              <div class="form-group">
                <label for="category">分類</label>
                <input 
                  type="text" 
                  id="category" 
                  v-model="form.category" 
                  required 
                />
              </div>
              <div class="form-group">
                <label for="content">內容</label>
                <textarea 
                  id="content" 
                  v-model="form.content" 
                  required
                ></textarea>
              </div>
              <button type="submit" :disabled="loading">
                {{ loading ? '新增中...' : '新增文章' }}
              </button>
              <button type="button" @click="resetForm" class="secondary">
                清除
              </button>
            </form>
          </section>
        `,
        methods: {
          handleSubmit() {
            this.$emit("create-article", { ...this.form });
          },
          resetForm() {
            this.form = {
              title: "",
              category: "",
              content: "",
            };
          },
          clearForm() {
            this.resetForm();
          },
        },
      };

      // ArticleSearch 組件 - 搜尋功能
      const ArticleSearch = {
        props: ["loading"],
        emits: ["search", "load-all"],
        data() {
          return {
            filters: {
              keyword: "",
              category: "",
              dateFrom: "",
              dateTo: "",
            },
          };
        },
        template: `
          <section>
            <h2>搜尋文章</h2>
            <div class="search-section">
              <div class="search-row">
                <div>
                  <label for="searchKeyword">關鍵字</label>
                  <input
                    type="text"
                    id="searchKeyword"
                    v-model="filters.keyword"
                    placeholder="搜尋標題或內容"
                  />
                </div>
                <div>
                  <label for="searchCategory">分類</label>
                  <input 
                    type="text" 
                    id="searchCategory" 
                    v-model="filters.category"
                    placeholder="特定分類" 
                  />
                </div>
              </div>
              <div class="search-row">
                <div>
                  <label for="searchDateFrom">開始日期</label>
                  <input 
                    type="date" 
                    id="searchDateFrom" 
                    v-model="filters.dateFrom"
                  />
                </div>
                <div>
                  <label for="searchDateTo">結束日期</label>
                  <input 
                    type="date" 
                    id="searchDateTo" 
                    v-model="filters.dateTo"
                  />
                </div>
              </div>
              <button @click="handleSearch" :disabled="loading">
                {{ loading ? '搜尋中...' : '搜尋' }}
              </button>
              <button @click="handleLoadAll" class="secondary" :disabled="loading">
                顯示全部
              </button>
            </div>
          </section>
        `,
        methods: {
          handleSearch() {
            this.$emit("search", { ...this.filters });
          },
          handleLoadAll() {
            this.$emit("load-all");
          },
        },
      };

      // ArticleList 組件 - 文章列表和編輯
      const ArticleList = {
        props: ["articles", "loading"],
        emits: ["update-article"],
        data() {
          return {
            editingId: null,
            editForm: {
              title: "",
              category: "",
              content: "",
            },
          };
        },
        template: `
          <section>
            <h2>文章列表</h2>
            <div v-if="loading && articles.length === 0" class="loading">
              載入中...
            </div>
            <div v-else-if="articles.length === 0" class="loading">
              沒有找到文章
            </div>
            <div v-else>
              <div 
                v-for="article in articles" 
                :key="article.id" 
                class="article-item"
              >
                <h3>{{ article.title }}</h3>
                <div class="article-meta">
                  分類: {{ article.category }} | 
                  建立: {{ formatDate(article.created_at) }} |
                  更新: {{ formatDate(article.updated_at) }}
                </div>
                <p>
                  {{ article.content.substring(0, 150) }}
                  <span v-if="article.content.length > 150">...</span>
                </p>
                <div class="article-actions">
                  <button @click="toggleEdit(article.id)">編輯</button>
                </div>
                
                <!-- 編輯表單 -->
                <div 
                  v-if="editingId === article.id" 
                  class="edit-form"
                >
                  <form @submit.prevent="handleUpdate(article.id)">
                    <div class="form-group">
                      <label>標題</label>
                      <input 
                        type="text" 
                        v-model="editForm.title" 
                        required
                      >
                    </div>
                    <div class="form-group">
                      <label>分類</label>
                      <input 
                        type="text" 
                        v-model="editForm.category" 
                        required
                      >
                    </div>
                    <div class="form-group">
                      <label>內容</label>
                      <textarea 
                        v-model="editForm.content" 
                        required
                      ></textarea>
                    </div>
                    <button type="submit" :disabled="loading">
                      {{ loading ? '更新中...' : '更新' }}
                    </button>
                    <button 
                      type="button" 
                      @click="cancelEdit" 
                      class="secondary"
                    >
                      取消
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </section>
        `,
        methods: {
          toggleEdit(id) {
            if (this.editingId === id) {
              this.cancelEdit();
            } else {
              const article = this.articles.find((a) => a.id === id);
              if (article) {
                this.editingId = id;
                this.editForm = {
                  title: article.title,
                  category: article.category,
                  content: article.content,
                };
              }
            }
          },
          cancelEdit() {
            this.editingId = null;
            this.editForm = {
              title: "",
              category: "",
              content: "",
            };
          },
          handleUpdate(id) {
            this.$emit("update-article", id, { ...this.editForm });
            this.cancelEdit();
          },
          formatDate(dateStr) {
            if (!dateStr) return "N/A";
            return new Date(dateStr).toLocaleString("zh-TW");
          },
        },
      };

      // 主應用程式
      createApp({
        components: {
          MessageDisplay,
          ArticleForm,
          ArticleSearch,
          ArticleList,
        },
        data() {
          return {
            // 狀態管理
            loading: false,
            articles: [],

            // 訊息系統
            message: {
              text: "",
              type: "",
            },
          };
        },

        mounted() {
          this.loadAllArticles();
        },

        methods: {
          // API 設定
          getApiUrl(path) {
            return `/api${path}`;
          },

          // 訊息處理
          showMessage(text, type = "success") {
            this.message = { text, type };
          },

          clearMessage() {
            this.message = { text: "", type: "" };
          },

          showError(text) {
            this.showMessage(text, "error");
          },

          showSuccess(text) {
            this.showMessage(text, "success");
          },

          // 載入所有文章
          async loadAllArticles() {
            try {
              this.loading = true;
              const response = await fetch(this.getApiUrl("/articles"));

              if (!response.ok) {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`
                );
              }

              this.articles = await response.json();
            } catch (error) {
              this.showError("載入文章失敗: " + error.message);
              console.error("載入文章錯誤:", error);
            } finally {
              this.loading = false;
            }
          },

          // 搜尋文章
          async searchArticles(filters) {
            try {
              this.loading = true;
              const params = new URLSearchParams();

              if (filters.keyword) params.set("keyword", filters.keyword);
              if (filters.category) params.set("category", filters.category);
              if (filters.dateFrom) params.set("dateFrom", filters.dateFrom);
              if (filters.dateTo) params.set("dateTo", filters.dateTo);

              const url =
                this.getApiUrl("/articles/search") +
                (params.toString() ? "?" + params.toString() : "");
              const response = await fetch(url);

              if (!response.ok) {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`
                );
              }

              this.articles = await response.json();
            } catch (error) {
              this.showError("搜尋失敗: " + error.message);
              console.error("搜尋錯誤:", error);
            } finally {
              this.loading = false;
            }
          },

          // 新增文章
          async createArticle(articleData) {
            try {
              this.loading = true;

              const response = await fetch(this.getApiUrl("/articles"), {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(articleData),
              });

              if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || response.statusText);
              }

              this.showSuccess("文章新增成功");
              this.$refs.articleForm.clearForm();
              await this.loadAllArticles();
            } catch (error) {
              this.showError("新增失敗: " + error.message);
              console.error("新增文章錯誤:", error);
            } finally {
              this.loading = false;
            }
          },

          // 更新文章
          async updateArticle(id, updateData) {
            try {
              this.loading = true;

              const response = await fetch(this.getApiUrl(`/articles/${id}`), {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(updateData),
              });

              if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || response.statusText);
              }

              this.showSuccess("文章更新成功");
              await this.loadAllArticles();
            } catch (error) {
              this.showError("更新失敗: " + error.message);
              console.error("更新文章錯誤:", error);
            } finally {
              this.loading = false;
            }
          },

          // 組件事件處理器
          handleCreateArticle(articleData) {
            this.createArticle(articleData);
          },

          handleSearch(filters) {
            this.searchArticles(filters);
          },

          handleLoadAll() {
            this.loadAllArticles();
          },

          handleUpdateArticle(id, updateData) {
            this.updateArticle(id, updateData);
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
