<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>éƒ¨è½æ ¼å¾Œå°ç®¡ç†</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        margin: 0;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1,
      h2 {
        color: #333;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      textarea {
        height: 120px;
        resize: vertical;
      }
      button {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
      }
      button:hover {
        background: #0056b3;
      }
      button.secondary {
        background: #6c757d;
      }
      button.danger {
        background: #dc3545;
      }
      button.ai-assist {
        background: #28a745;
        margin-left: 10px;
      }
      button.ai-assist:hover {
        background: #218838;
      }
      .ai-panel {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        display: none;
      }
      .ai-panel.show {
        display: block;
        animation: slideDown 0.3s ease-out;
      }
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .ai-prompt-group {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }
      .ai-prompt-group input {
        flex: 1;
      }
      .ai-result {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin-top: 10px;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }
      .ai-actions {
        margin-top: 10px;
      }
      .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .search-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }
      .search-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .search-row > div {
        flex: 1;
      }
      .articles-list {
        margin-top: 20px;
      }
      .article-item {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 4px;
      }
      .article-meta {
        color: #666;
        font-size: 0.9em;
      }
      .article-actions {
        margin-top: 10px;
      }
      .edit-form {
        display: none;
        background: #f8f9fa;
        padding: 15px;
        margin-top: 10px;
        border-radius: 4px;
      }
      .hidden {
        display: none;
      }
      .loading {
        color: #666;
        font-style: italic;
      }
      .error {
        color: #dc3545;
        background: #f8d7da;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .success {
        color: #155724;
        background: #d4edda;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .message {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .message.success {
        color: #155724;
        background: #d4edda;
        border: 1px solid #c3e6cb;
      }
      .message.error {
        color: #721c24;
        background: #f8d7da;
        border: 1px solid #f5c6cb;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
      }
      .fade-enter-active,
      .fade-leave-active {
        transition: opacity 0.3s;
      }
      .fade-enter-from,
      .fade-leave-to {
        opacity: 0;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="container">
        <h1>éƒ¨è½æ ¼å¾Œå°ç®¡ç†</h1>

        <!-- è¨Šæ¯æç¤ºçµ„ä»¶ -->
        <message-display
          :message="message"
          @clear="clearMessage"
        ></message-display>

        <!-- æ–°å¢æ–‡ç« è¡¨å–®çµ„ä»¶ -->
        <article-form
          ref="articleForm"
          :loading="loading"
          @create-article="handleCreateArticle"
        ></article-form>

        <!-- æœå°‹çµ„ä»¶ -->
        <article-search
          :loading="loading"
          @search="handleSearch"
          @load-all="handleLoadAll"
        ></article-search>

        <!-- æ–‡ç« åˆ—è¡¨çµ„ä»¶ -->
        <article-list
          :articles="articles"
          :loading="loading"
          @update-article="handleUpdateArticle"
        ></article-list>
      </div>
    </div>

    <script>
      const { createApp } = Vue;

      // MessageDisplay çµ„ä»¶ - è™•ç†è¨Šæ¯é¡¯ç¤º
      const MessageDisplay = {
        props: ["message"],
        emits: ["clear"],
        template: `
          <div v-if="message.text" :class="['message', message.type]">
            {{ message.text }}
          </div>
        `,
        mounted() {
          if (this.message.text) {
            setTimeout(
              () => {
                this.$emit("clear");
              },
              this.message.type === "error" ? 5000 : 3000
            );
          }
        },
        watch: {
          "message.text"() {
            if (this.message.text) {
              setTimeout(
                () => {
                  this.$emit("clear");
                },
                this.message.type === "error" ? 5000 : 3000
              );
            }
          },
        },
      };

      // ArticleForm çµ„ä»¶ - æ–°å¢æ–‡ç« è¡¨å–®
      const ArticleForm = {
        props: ["loading"],
        emits: ["create-article"],
        data() {
          return {
            form: {
              title: "",
              category: "",
              content: "",
            },
            aiPanel: {
              show: false,
              loading: false,
              prompt: "",
              result: "",
            },
          };
        },
        template: `
          <section>
            <h2>æ–°å¢æ–‡ç« </h2>
            <form @submit.prevent="handleSubmit">
              <div class="form-group">
                <label for="title">æ¨™é¡Œ</label>
                <input 
                  type="text" 
                  id="title" 
                  v-model="form.title" 
                  required 
                />
              </div>
              <div class="form-group">
                <label for="category">åˆ†é¡</label>
                <input 
                  type="text" 
                  id="category" 
                  v-model="form.category" 
                  required 
                />
              </div>
              <div class="form-group">
                <label for="content">å…§å®¹</label>
                <textarea 
                  id="content" 
                  v-model="form.content" 
                  required
                ></textarea>
                <button 
                  type="button" 
                  @click="toggleAiPanel" 
                  class="ai-assist"
                  :disabled="loading || aiPanel.loading"
                >
                  ğŸ¤– AI å”åŠ©
                </button>
              </div>
              
              <!-- AI å”åŠ©é¢æ¿ -->
              <div :class="['ai-panel', { show: aiPanel.show }]">
                <h4>ğŸ¤– AI å¯«ä½œå”åŠ©</h4>
                <div class="ai-prompt-group">
                  <input 
                    type="text" 
                    v-model="aiPanel.prompt" 
                    placeholder="è¼¸å…¥æ‚¨çš„éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šå¹«æˆ‘å¯«ä¸€ç¯‡é—œæ–¼ JavaScript çš„æ–‡ç« "
                    @keyup.enter="handleAiAssist"
                  />
                  <button 
                    type="button" 
                    @click="handleAiAssist" 
                    :disabled="!aiPanel.prompt.trim() || aiPanel.loading"
                  >
                    <span v-if="aiPanel.loading" class="loading-spinner"></span>
                    {{ aiPanel.loading ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆå…§å®¹' }}
                  </button>
                </div>
                
                <div v-if="aiPanel.result" class="ai-result">
                  {{ aiPanel.result }}
                </div>
                
                <div v-if="aiPanel.result" class="ai-actions">
                  <button type="button" @click="applyAiResult">
                    å¥—ç”¨åˆ°å…§å®¹
                  </button>
                  <button type="button" @click="appendAiResult" class="secondary">
                    é™„åŠ åˆ°å…§å®¹
                  </button>
                  <button type="button" @click="clearAiResult" class="secondary">
                    æ¸…é™¤çµæœ
                  </button>
                </div>
              </div>
              
              <button type="submit" :disabled="loading">
                {{ loading ? 'æ–°å¢ä¸­...' : 'æ–°å¢æ–‡ç« ' }}
              </button>
              <button type="button" @click="resetForm" class="secondary">
                æ¸…é™¤
              </button>
            </form>
          </section>
        `,
        methods: {
          handleSubmit() {
            this.$emit("create-article", { ...this.form });
          },
          resetForm() {
            this.form = {
              title: "",
              category: "",
              content: "",
            };
            this.aiPanel = {
              show: false,
              loading: false,
              prompt: "",
              result: "",
            };
          },
          clearForm() {
            this.resetForm();
          },
          toggleAiPanel() {
            this.aiPanel.show = !this.aiPanel.show;
            if (!this.aiPanel.show) {
              this.clearAiResult();
            }
          },
          async handleAiAssist() {
            if (!this.aiPanel.prompt.trim()) return;

            try {
              this.aiPanel.loading = true;

              const requestBody = {
                prompt: this.aiPanel.prompt,
                articleContent: this.form.content || undefined,
              };

              const response = await fetch("/api/ai/assist", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(requestBody),
              });

              if (!response.ok) {
                throw new Error(`AI å”åŠ©å¤±æ•—: ${response.status}`);
              }

              const result = await response.json();
              this.aiPanel.result =
                result.improvedContent || result.content || "ç„¡æ³•ç²å¾— AI å›æ‡‰";
            } catch (error) {
              console.error("AI å”åŠ©éŒ¯èª¤:", error);
              this.aiPanel.result = `éŒ¯èª¤: ${error.message}`;
            } finally {
              this.aiPanel.loading = false;
            }
          },
          applyAiResult() {
            this.form.content = this.aiPanel.result;
            this.clearAiResult();
          },
          appendAiResult() {
            this.form.content = this.form.content
              ? this.form.content + "\n\n" + this.aiPanel.result
              : this.aiPanel.result;
            this.clearAiResult();
          },
          clearAiResult() {
            this.aiPanel.result = "";
            this.aiPanel.prompt = "";
          },
        },
      };

      // ArticleSearch çµ„ä»¶ - æœå°‹åŠŸèƒ½
      const ArticleSearch = {
        props: ["loading"],
        emits: ["search", "load-all"],
        data() {
          return {
            filters: {
              keyword: "",
              category: "",
              dateFrom: "",
              dateTo: "",
            },
          };
        },
        template: `
          <section>
            <h2>æœå°‹æ–‡ç« </h2>
            <div class="search-section">
              <div class="search-row">
                <div>
                  <label for="searchKeyword">é—œéµå­—</label>
                  <input
                    type="text"
                    id="searchKeyword"
                    v-model="filters.keyword"
                    placeholder="æœå°‹æ¨™é¡Œæˆ–å…§å®¹"
                  />
                </div>
                <div>
                  <label for="searchCategory">åˆ†é¡</label>
                  <input 
                    type="text" 
                    id="searchCategory" 
                    v-model="filters.category"
                    placeholder="ç‰¹å®šåˆ†é¡" 
                  />
                </div>
              </div>
              <div class="search-row">
                <div>
                  <label for="searchDateFrom">é–‹å§‹æ—¥æœŸ</label>
                  <input 
                    type="date" 
                    id="searchDateFrom" 
                    v-model="filters.dateFrom"
                  />
                </div>
                <div>
                  <label for="searchDateTo">çµæŸæ—¥æœŸ</label>
                  <input 
                    type="date" 
                    id="searchDateTo" 
                    v-model="filters.dateTo"
                  />
                </div>
              </div>
              <button @click="handleSearch" :disabled="loading">
                {{ loading ? 'æœå°‹ä¸­...' : 'æœå°‹' }}
              </button>
              <button @click="handleLoadAll" class="secondary" :disabled="loading">
                é¡¯ç¤ºå…¨éƒ¨
              </button>
            </div>
          </section>
        `,
        methods: {
          handleSearch() {
            this.$emit("search", { ...this.filters });
          },
          handleLoadAll() {
            this.$emit("load-all");
          },
        },
      };

      // ArticleList çµ„ä»¶ - æ–‡ç« åˆ—è¡¨å’Œç·¨è¼¯
      const ArticleList = {
        props: ["articles", "loading"],
        emits: ["update-article"],
        data() {
          return {
            editingId: null,
            editForm: {
              title: "",
              category: "",
              content: "",
            },
            aiPanel: {
              show: false,
              loading: false,
              prompt: "",
              result: "",
            },
          };
        },
        template: `
          <section>
            <h2>æ–‡ç« åˆ—è¡¨</h2>
            <div v-if="loading && articles.length === 0" class="loading">
              è¼‰å…¥ä¸­...
            </div>
            <div v-else-if="articles.length === 0" class="loading">
              æ²’æœ‰æ‰¾åˆ°æ–‡ç« 
            </div>
            <div v-else>
              <div 
                v-for="article in articles" 
                :key="article.id" 
                class="article-item"
              >
                <h3>{{ article.title }}</h3>
                <div class="article-meta">
                  åˆ†é¡: {{ article.category }} | 
                  å»ºç«‹: {{ formatDate(article.created_at) }} |
                  æ›´æ–°: {{ formatDate(article.updated_at) }}
                </div>
                <p>
                  {{ article.content.substring(0, 150) }}
                  <span v-if="article.content.length > 150">...</span>
                </p>
                <div class="article-actions">
                  <button @click="toggleEdit(article.id)">ç·¨è¼¯</button>
                </div>
                
                <!-- ç·¨è¼¯è¡¨å–® -->
                <div 
                  v-if="editingId === article.id" 
                  class="edit-form"
                >
                  <form @submit.prevent="handleUpdate(article.id)">
                    <div class="form-group">
                      <label>æ¨™é¡Œ</label>
                      <input 
                        type="text" 
                        v-model="editForm.title" 
                        required
                      >
                    </div>
                    <div class="form-group">
                      <label>åˆ†é¡</label>
                      <input 
                        type="text" 
                        v-model="editForm.category" 
                        required
                      >
                    </div>
                    <div class="form-group">
                      <label>å…§å®¹</label>
                      <textarea 
                        v-model="editForm.content" 
                        required
                      ></textarea>
                      <button 
                        type="button" 
                        @click="toggleAiPanel" 
                        class="ai-assist"
                        :disabled="loading || aiPanel.loading"
                      >
                        ğŸ¤– AI å”åŠ©
                      </button>
                    </div>
                    
                    <!-- AI å”åŠ©é¢æ¿ -->
                    <div :class="['ai-panel', { show: aiPanel.show }]">
                      <h4>ğŸ¤– AI å¯«ä½œå”åŠ©</h4>
                      <div class="ai-prompt-group">
                        <input 
                          type="text" 
                          v-model="aiPanel.prompt" 
                          placeholder="è¼¸å…¥æ‚¨çš„éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šæ”¹å–„é€™ç¯‡æ–‡ç« çš„çµæ§‹"
                          @keyup.enter="handleAiAssist"
                        />
                        <button 
                          type="button" 
                          @click="handleAiAssist" 
                          :disabled="!aiPanel.prompt.trim() || aiPanel.loading"
                        >
                          <span v-if="aiPanel.loading" class="loading-spinner"></span>
                          {{ aiPanel.loading ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆå…§å®¹' }}
                        </button>
                      </div>
                      
                      <div v-if="aiPanel.result" class="ai-result">
                        {{ aiPanel.result }}
                      </div>
                      
                      <div v-if="aiPanel.result" class="ai-actions">
                        <button type="button" @click="applyAiResult">
                          å¥—ç”¨åˆ°å…§å®¹
                        </button>
                        <button type="button" @click="appendAiResult" class="secondary">
                          é™„åŠ åˆ°å…§å®¹
                        </button>
                        <button type="button" @click="clearAiResult" class="secondary">
                          æ¸…é™¤çµæœ
                        </button>
                      </div>
                    </div>
                    
                    <button type="submit" :disabled="loading">
                      {{ loading ? 'æ›´æ–°ä¸­...' : 'æ›´æ–°' }}
                    </button>
                    <button 
                      type="button" 
                      @click="cancelEdit" 
                      class="secondary"
                    >
                      å–æ¶ˆ
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </section>
        `,
        methods: {
          toggleEdit(id) {
            if (this.editingId === id) {
              this.cancelEdit();
            } else {
              const article = this.articles.find((a) => a.id === id);
              if (article) {
                this.editingId = id;
                this.editForm = {
                  title: article.title,
                  category: article.category,
                  content: article.content,
                };
                this.aiPanel = {
                  show: false,
                  loading: false,
                  prompt: "",
                  result: "",
                };
              }
            }
          },
          cancelEdit() {
            this.editingId = null;
            this.editForm = {
              title: "",
              category: "",
              content: "",
            };
            this.aiPanel = {
              show: false,
              loading: false,
              prompt: "",
              result: "",
            };
          },
          handleUpdate(id) {
            this.$emit("update-article", id, { ...this.editForm });
            this.cancelEdit();
          },
          formatDate(dateStr) {
            if (!dateStr) return "N/A";
            return new Date(dateStr).toLocaleString("zh-TW");
          },
          toggleAiPanel() {
            this.aiPanel.show = !this.aiPanel.show;
            if (!this.aiPanel.show) {
              this.clearAiResult();
            }
          },
          async handleAiAssist() {
            if (!this.aiPanel.prompt.trim()) return;

            try {
              this.aiPanel.loading = true;

              const requestBody = {
                prompt: this.aiPanel.prompt,
                articleContent: this.editForm.content || undefined,
              };

              const response = await fetch("/api/ai/assist", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(requestBody),
              });

              if (!response.ok) {
                throw new Error(`AI å”åŠ©å¤±æ•—: ${response.status}`);
              }

              const result = await response.json();
              this.aiPanel.result =
                result.improvedContent || result.content || "ç„¡æ³•ç²å¾— AI å›æ‡‰";
            } catch (error) {
              console.error("AI å”åŠ©éŒ¯èª¤:", error);
              this.aiPanel.result = `éŒ¯èª¤: ${error.message}`;
            } finally {
              this.aiPanel.loading = false;
            }
          },
          applyAiResult() {
            this.editForm.content = this.aiPanel.result;
            this.clearAiResult();
          },
          appendAiResult() {
            this.editForm.content = this.editForm.content
              ? this.editForm.content + "\n\n" + this.aiPanel.result
              : this.aiPanel.result;
            this.clearAiResult();
          },
          clearAiResult() {
            this.aiPanel.result = "";
            this.aiPanel.prompt = "";
          },
        },
      };

      // ä¸»æ‡‰ç”¨ç¨‹å¼
      createApp({
        components: {
          MessageDisplay,
          ArticleForm,
          ArticleSearch,
          ArticleList,
        },
        data() {
          return {
            // ç‹€æ…‹ç®¡ç†
            loading: false,
            articles: [],

            // è¨Šæ¯ç³»çµ±
            message: {
              text: "",
              type: "",
            },
          };
        },

        mounted() {
          this.loadAllArticles();
        },

        methods: {
          // API è¨­å®š
          getApiUrl(path) {
            return `/api${path}`;
          },

          // è¨Šæ¯è™•ç†
          showMessage(text, type = "success") {
            this.message = { text, type };
          },

          clearMessage() {
            this.message = { text: "", type: "" };
          },

          showError(text) {
            this.showMessage(text, "error");
          },

          showSuccess(text) {
            this.showMessage(text, "success");
          },

          // è¼‰å…¥æ‰€æœ‰æ–‡ç« 
          async loadAllArticles() {
            try {
              this.loading = true;
              const response = await fetch(this.getApiUrl("/articles"));

              if (!response.ok) {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`
                );
              }

              this.articles = await response.json();
            } catch (error) {
              this.showError("è¼‰å…¥æ–‡ç« å¤±æ•—: " + error.message);
              console.error("è¼‰å…¥æ–‡ç« éŒ¯èª¤:", error);
            } finally {
              this.loading = false;
            }
          },

          // æœå°‹æ–‡ç« 
          async searchArticles(filters) {
            try {
              this.loading = true;
              const params = new URLSearchParams();

              if (filters.keyword) params.set("keyword", filters.keyword);
              if (filters.category) params.set("category", filters.category);
              if (filters.dateFrom) params.set("dateFrom", filters.dateFrom);
              if (filters.dateTo) params.set("dateTo", filters.dateTo);

              const url =
                this.getApiUrl("/articles/search") +
                (params.toString() ? "?" + params.toString() : "");
              const response = await fetch(url);

              if (!response.ok) {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`
                );
              }

              this.articles = await response.json();
            } catch (error) {
              this.showError("æœå°‹å¤±æ•—: " + error.message);
              console.error("æœå°‹éŒ¯èª¤:", error);
            } finally {
              this.loading = false;
            }
          },

          // æ–°å¢æ–‡ç« 
          async createArticle(articleData) {
            try {
              this.loading = true;

              const response = await fetch(this.getApiUrl("/articles"), {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(articleData),
              });

              if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || response.statusText);
              }

              this.showSuccess("æ–‡ç« æ–°å¢æˆåŠŸ");
              this.$refs.articleForm.clearForm();
              await this.loadAllArticles();
            } catch (error) {
              this.showError("æ–°å¢å¤±æ•—: " + error.message);
              console.error("æ–°å¢æ–‡ç« éŒ¯èª¤:", error);
            } finally {
              this.loading = false;
            }
          },

          // æ›´æ–°æ–‡ç« 
          async updateArticle(id, updateData) {
            try {
              this.loading = true;

              const response = await fetch(this.getApiUrl(`/articles/${id}`), {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(updateData),
              });

              if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || response.statusText);
              }

              this.showSuccess("æ–‡ç« æ›´æ–°æˆåŠŸ");
              await this.loadAllArticles();
            } catch (error) {
              this.showError("æ›´æ–°å¤±æ•—: " + error.message);
              console.error("æ›´æ–°æ–‡ç« éŒ¯èª¤:", error);
            } finally {
              this.loading = false;
            }
          },

          // çµ„ä»¶äº‹ä»¶è™•ç†å™¨
          handleCreateArticle(articleData) {
            this.createArticle(articleData);
          },

          handleSearch(filters) {
            this.searchArticles(filters);
          },

          handleLoadAll() {
            this.loadAllArticles();
          },

          handleUpdateArticle(id, updateData) {
            this.updateArticle(id, updateData);
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
